<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
    <link rel="stylesheet" href="css/materialize.css">
    <!--<link rel="stylesheet" type="text/css" href="css/admin.css">-->
    <link rel="stylesheet" type="text/css" href="css/mapa.css">
    <link rel="stylesheet" type="text/css" href="css/semantic.min.css">
    <!-- <link rel="stylesheet" type="text/css" href="css/style.css"> -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
    integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
    crossorigin=""/>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css">
    
    <script src="js/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="js/materialize.js"></script>
    
    <style>
       #map {
        height: 680px;
        /*width: 100%;*/
       }
    </style>
  </head>
  <body>
    
    <%- include templates/sidenav.ejs %>

    <main>
      
      
      <a class="btn-floating btn-large waves-effect waves-light modal-trigger red add" onclick="addMark();"><i class="material-icons" onclick="">add</i></a>
      
      <div id="map" ></div>
      
      <!-- Modal Structure -->
      <div id="modal1" style="z-index: 100;" class="modal">
        <div class="modal-content">

          
          <!-- <hr> -->
          
          <form class="ui form" method="post" action="/denuncias">
      
              <h1 class="ui dividing header">Registrar Denúncia</h1>
              <div class="field"> 
                        
                    <label>Data ocorreu</label>
                    <input type="text" placeholder="dd/mm/aaaa" name="dataocorreu" class="date">
                      
              </div>

              <div class="field">
                  
                  <label>Hora que ocorreu</label>
                  <input type="text" placeholder="hh:mm:ss" name="horaocorreu" class="time">
                  
              </div>
      
              <div class="field">  
                
                <label>Desordem</label>
                <select name="desordem">
                    <option value="" disabled selected>Selecione a Desordem</option>
                    <% if(desordens){ 
                        for(var i = 0; i < desordens.length; i++){%>
                            <option value=<%= desordens[i].des_iddesordem %> ><%= desordens[i].des_descricao %></option>
                        <% }} %>
                </select>
               
              </div>

               <div class="field">
                  
                    <label >Descrição</label>
                    <textarea  name="descricao" type="text"  class="materialize-textarea"></textarea>
                  
              </div>
      
               <div class="field">
                  
                    <label>Anonimato</label>
                    <input placeholder="anonimato" name="anonimato" type="number" class="validate">
                  
              </div>

              <div style="display: none;">
                <input name="latitude" id="latitudemp" type="text" value=" ">
                <input name="longitude" id="longitudemp" type="text" value=" ">
              </div>

            </div>
            <div class="modal-footer">
                
                <button class="ui primary botton" type="submit" name="action">Salvar
                </button>

            </div>
            
          </form>
          </div>

          <!-- <button id="hey">asçdfkaçsldfkaçsdlfkçasdlfk</button> -->
    </main>

    

    <script type="text/javascript" src="js/instaciando_materialize.js"></script>
    <script type="text/javascript" src="js/init_dom.js"></script>
    <script type="text/javascript" src="js/jquery.mask.js"></script>
    
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
    integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js"></script>
    <script type="text/javascript">

        document.addEventListener('DOMContentLoaded', function() {
          var elems = document.querySelectorAll('.modal');
          var instances = M.Modal.init(elems);
        });
        
        var marker_zoom_x;
        var marker_zoom_y;
        var query = <%-JSON.stringify(query)%>;
        var markes = <%-JSON.stringify(pontos)%>;
        var polygons = <%-JSON.stringify(polygons)%>;

        markes.forEach(function (marker){
          if(marker.den_iddenuncia == query.denuncia){
            marker_zoom_x = marker.st_x;
            marker_zoom_y = marker.st_y;
          }
        })

        if(jQuery.isEmptyObject(query)){
          var map = L.map('map').setView([-15.782759, -47.870619], 13);
        }else{
          var map = L.map('map', {
              center: [marker_zoom_x, marker_zoom_y],
              zoom: 18
          });
        }
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var markersGroup = L.markerClusterGroup();

        //ADIÇÃO DE MARCADORES NO MAPA
        for(var i = 0; i < markes.length; i++){

          var marker = L.marker([markes[i].st_x, markes[i].st_y]);
          marker.bindPopup("<b>" + markes[i].den_status + "</b><hr><span>" + markes[i].den_descricao + "</span><br><br><a href=\"/denuncias/" + markes[i].den_iddenuncia + "/show\">Ver denúnica</a>");
          markersGroup.addLayer( marker );

        
        }

        map.addLayer( markersGroup );
        
        //ADIÇÃO DE POLIGONOS NO MAPA
        for(var i = 0; i < polygons.length; i++){
          
          polygons[i].reg_regiao_alerta = polygons[i].reg_regiao_alerta.replace(/\(/g, "[").replace(/\)/g, "]");
          var array_poly = JSON.parse(polygons[i].reg_regiao_alerta); 

          var polygon = L.polygon(array_poly,{
            color : 'red'
          }).addTo(map);
        }

        var latitude;
        var longitude;

        //TODA VEZ QUE OCORRE UM CLIQUE NO MAPA, AS VARIÁVEIS RECEBEM LATITUDE E LONGITUDE
        map.on('dblclick', function(e) {
          latitude = e.latlng.lat;
          longitude = e.latlng.lng;
          // alert(latitude + " " + longitude);
        })
        
        function addMark(){
          
          alert("Clique 2 vezes no lugar que gostaria de registrar a denúnica");
          $("#map").css("cursor", "pointer");
          $("#map").one("dblclick", function(){
            
            // map.zoomControl.disabled();
            $("#latitudemp").val(String(latitude));
            $("#longitudemp").val(String(longitude));
            $("#modal1").modal("open");
            $("#map").css("cursor", "");

          })
        } 

    </script>
  </body>
</html>
